<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8>
<link rel="stylesheet" href="../css/style.css">
<title>Spacecraft Simulator</title>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

<script src="../../../../../coreweb/lib/microevent/microevent-1.0.0.js"></script>
<script src="../../../../../coreweb/lib/moment/moment.min-2.10.3.js"></script>
<script src="../../../../../coreweb/lib/require/require-2.1.22.js" data-main="../js/Body.js"></script>
<script src="../../../../../coreweb/lib/three/three.min-0.73.0.js"></script>

<script src="../../../../../coreweb/src/main/js/util/JavaScriptAugments.js"></script>
<script src="../../../../../coreweb/src/main/js/util/Logger.js"></script>
<script src="../../../../../coreweb/src/main/js/util/InputValidator.js"></script>
<script src="../../../../../coreweb/src/main/js/util/ArrayAugments.js"></script>
</head>
<body>
	<table>
		<tr>
			<td>Observer Satellite <select id="observerSelect">
					<option value="sol">Sol</option>
					<option value="mercury">Mercury</option>
					<option value="venus">Venus</option>
					<option value="earth">Earth</option>
					<option value="mars">Mars</option>
					<option value="jupiter">Jupiter</option>
			</select></td>
		</tr>
		<tr>
			<td>
				<canvas id="observerCameraUI"></canvas>
			</td>
		</tr>
	</table>
	<table>
		<tr>
			<td></td>
			<td>Dorsal</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td></td>
			<td><canvas id="dorsalCameraUI"></canvas></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td>Port</td>
			<td>Forward</td>
			<td>Starboard</td>
			<td>Aft</td>
		</tr>
		<tr>
			<td><canvas id="portCameraUI"></canvas></td>
			<td><canvas id="forwardCameraUI"></canvas></td>
			<td><canvas id="starboardCameraUI"></canvas></td>
			<td><canvas id="aftCameraUI"></canvas></td>
		</tr>
		<tr>
			<td></td>
			<td>Ventral</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td></td>
			<td><canvas id="ventralCameraUI"></canvas></td>
			<td></td>
			<td></td>
		</tr>
	</table>
	<script>
        "use strict";
        var LOGGER = new Logger();
        LOGGER.setTraceEnabled(false);
        LOGGER.setDebugEnabled(false);

        var resourceBase = "https://raw.githubusercontent.com/jmthompson2015/vizzini/master/hobby/simulator/src/main/resources/";
        // var resourceBase = "/Volumes/StorageDrive/jmthompson/git/vizzini/hobby/simulator/src/main/resources/";
        var imageBase = resourceBase + "images/";

        require([ "Body", "Environment", "Quaternion", "StateFactory", "Vector", "ship/Ship", "ui/SensorUI" ],
                function(Body, Environment, Quaternion, StateFactory, Vector, Ship, SensorUI)
                {
                    document.getElementById("observerSelect").onchange = function()
                    {
                        setObserver(this.options[this.selectedIndex].value)
                    };

                    var environment;
                    var observerSensor;
                    var observerSensorUI;

                    function setObserver(bodyKey)
                    {
                        LOGGER.info("setObserver() bodyKey = " + bodyKey);
                        var body = Body.properties[bodyKey];
                        observerSensor = environment.ship(body.name + " Observer").device("Camera");
                        observerSensorUI.sensor(observerSensor);
                    }

                    createEnvironment();

                    function createEnvironment()
                    {
                        var bodyKeys = [ Body.SOL, Body.MERCURY, Body.VENUS, Body.EARTH, Body.LUNA, Body.MARS,
                                Body.PHOBOS, Body.DEIMOS, Body.JUPITER, Body.IO, Body.EUROPA, Body.GANYMEDE,
                                Body.CALLISTO ];
                        var factory = new StateFactory.Horizons(bodyKeys, finishEnvironment);
                        factory.createStates();
                    }

                    function finishEnvironment(bodyToState)
                    {
                        environment = new Environment(bodyToState);
                        var solState = bodyToState[Body.SOL];

                        for ( var bodyKey in bodyToState)
                        {
                            var body = Body.properties[bodyKey];
                            var name = body.name + " Observer";
                            var parentState = bodyToState[bodyKey];
                            var distance = 3.0 * body.maxRadius;
                            var satellite = new Ship.ObserverSatellite(name, environment);
                            var state = StateFactory.createCircularOrbit(solState, bodyKey, parentState, distance);
                            environment.addShip(satellite, state.position(), state.orientation(), state.velocity(),
                                    state.angularVelocity());
                        }

                        var ship = new Ship.ReferenceShip("ReferenceShip", environment);
                        var state0 = bodyToState[Body.EARTH];
                        var position0 = state0.position();
                        var position = new Vector(position0.x(), position0.y() + 5.0e+04, position0.z());
                        var orientation = Quaternion.newInstance(-90.0, Vector.Z_AXIS);
                        var velocity = state0.velocity();
                        environment.addShip(ship, position, orientation, velocity);

                        finishInit();
                    }

                    function finishInit()
                    {
                        var parentKey = "ReferenceShip";
                        var ship = environment.ship(parentKey);
                        var portSensor = ship.device("PortCamera");
                        var forwardSensor = ship.device("ForwardCamera");
                        var starboardSensor = ship.device("StarboardCamera");
                        var aftSensor = ship.device("AftCamera");
                        var dorsalSensor = ship.device("DorsalCamera");
                        var ventralSensor = ship.device("VentralCamera");
                        var width = 275;
                        var height = width;

                        var portSensorUI = new SensorUI(portSensor, "portCameraUI", width, height);
                        var forwardSensorUI = new SensorUI(forwardSensor, "forwardCameraUI", width, height);
                        var starboardSensorUI = new SensorUI(starboardSensor, "starboardCameraUI", width, height);
                        var aftSensorUI = new SensorUI(aftSensor, "aftCameraUI", width, height);
                        var dorsalSensorUI = new SensorUI(dorsalSensor, "dorsalCameraUI", width, height);
                        var ventralSensorUI = new SensorUI(ventralSensor, "ventralCameraUI", width, height);

                        observerSensor = environment.ship("Sol Observer").device("Camera");
                        observerSensorUI = new SensorUI(observerSensor, "observerCameraUI", width, height);

                        var render = function()
                        {
                            requestAnimationFrame(render);

                            portSensorUI.render();
                            forwardSensorUI.render();
                            starboardSensorUI.render();
                            aftSensorUI.render();
                            dorsalSensorUI.render();
                            ventralSensorUI.render();

                            observerSensorUI.render();
                        };

                        var tick = function()
                        {
                            var lastUpdate = Date.now();
                            environment.tick();

                            var now = Date.now();
                            var delay = 1000 - (now - lastUpdate);
                            LOGGER.info("delay = " + delay + " ms diff = " + (now - lastUpdate));
                            setTimeout(tick, delay);
                        }

                        render();
                        tick();
                    }
                });
    </script>
</body>
</html>
