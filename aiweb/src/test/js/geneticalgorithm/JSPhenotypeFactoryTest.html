<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>JSPhenotypeFactoryTest</title>

<link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.15.0.css">
<script src="http://code.jquery.com/qunit/qunit-1.15.0.js"></script>

<script src="../../../../../coreweb/lib/jshint/jshint-2.8.0.js"></script>

<script src="../../../../../coreweb/src/main/js/util/Logger.js"></script>
<script src="../../../../../coreweb/src/main/js/util/InputValidator.js"></script>
<script src="../../../../../coreweb/src/main/js/util/ArrayAugments.js"></script>

<script src="../../../main/js/geneticalgorithm/JSPhenotypeFactory.js"></script>
<script src="../../../main/js/geneticalgorithm/GAUtilities.js"></script>

<script>
    "use strict";

    var LOGGER = new Logger();
    LOGGER.setTraceEnabled(false);
    LOGGER.setDebugEnabled(false);
    var SHOULD_THROW = "Should have thrown an exception.";

    QUnit.test("create()",
            function(assert)
            {
                // Setup.
                var genome = [ "return", "+", "a", "b" ];
                var isReturnUsed = false;
                var factory = new JSPhenotypeFactory("add", [ "a", "b" ],
                        isReturnUsed);
                var isDetailed = false;

                // Run.
                var result = factory.create(genome, isDetailed);

                // Verify.
                assert.ok(result);
                assert.ok(!genome.warningCount, 12);
                assert.ok(!genome.errorCount, 12);

                var inputs = [ [ 0, 0 ], [ 1, 2 ], [ 3, 4 ], [ 5, 6 ],
                        [ 7, 8 ], [ 9, 10 ], ];
                var outputs = [ 0, 3, 7, 11, 15, 19 ];

                for (var i = 0; i < outputs.length; i++)
                {
                    assert
                            .equal(result(inputs[i][0], inputs[i][1]),
                                    outputs[i]);
                }
            });

    QUnit.test("create() with if",
            function(assert)
            {
                // Setup.
                var genome = [ "if", ">", "a", "5", "=", "a", "+", "a", "6",
                        "return", "a", ";" ];
                var isReturnUsed = false;
                var factory = new JSPhenotypeFactory("maybeAdd", [ "a" ],
                        isReturnUsed);
                var isDetailed = false;

                // Run.
                var result = factory.create(genome, isDetailed);

                // Verify.
                assert.ok(result);
                assert.ok(!genome.warningCount, 12);
                assert.ok(!genome.errorCount, 12);

                var inputs = [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 ];
                var outputs = [ 0, 1, 2, 3, 4, 5, 12, 13, 14, 15 ];

                for (var i = 0; i < outputs.length; i++)
                {
                    assert.equal(result(inputs[i]), outputs[i]);
                }
            });

    QUnit.test("create() with issues",
            function(assert)
            {
                // Setup.
                var genome = [ "return", "=", "a", "+", "b", "-", "var", ";" ];
                var isReturnUsed = false;
                var factory = new JSPhenotypeFactory("add", [ "a", "b" ],
                        isReturnUsed);
                var isDetailed = true;

                // Run.
                var result = factory.create(genome, isDetailed);

                // Verify.
                assert.ok(!result);
                assert.equal(genome.warningCount, 3);
                assert.equal(genome.errorCount, 4);
            });

    QUnit.test("create() 1 missing term",
            function(assert)
            {
                // Setup.
                var genome = [ "return", "+", "a" ];
                var isReturnUsed = false;
                var factory = new JSPhenotypeFactory("add", [ "a", "b" ],
                        isReturnUsed);
                var isDetailed = true;

                // Run.
                var result = factory.create(genome, isDetailed);

                // Verify.
                assert.ok(!result);
                assert.ok(genome.issues);
                assert.equal(genome.issues.length, 6);
                assert.equal(genome.warningCount, 1);
                assert.equal(genome.errorCount, 4);
            });

    QUnit.test("create() 2 missing terms",
            function(assert)
            {
                // Setup.
                var genome = [ "return", "+" ];
                var isReturnUsed = false;
                var factory = new JSPhenotypeFactory("add", [ "a", "b" ],
                        isReturnUsed);
                var isDetailed = true;

                // Run.
                var result = factory.create(genome, isDetailed);

                // Verify.
                assert.ok(!result);
                assert.ok(genome.issues);
                assert.equal(genome.issues.length, 6);
                assert.equal(genome.warningCount, 1);
                assert.equal(genome.errorCount, 4);
            });

    QUnit.test("genomeToString()",
            function(assert)
            {
                // Setup.
                var genome = [ "return", "+", "a", "b" ];
                var isReturnUsed = false;
                var factory = new JSPhenotypeFactory("add", [ "a", "b" ],
                        isReturnUsed);

                // Run.
                var result = factory.genomeToString(genome);

                // Verify.
                assert.ok(result);
                assert.equal(result, "return (a + b)");
            });

    QUnit.test("genomeToString() using return",
            function(assert)
            {
                // Setup.
                var genome = [ "+", "a", "b" ];
                var isReturnUsed = true;
                var factory = new JSPhenotypeFactory("add", [ "a", "b" ],
                        isReturnUsed);

                // Run.
                var result = factory.genomeToString(genome);

                // Verify.
                assert.ok(result);
                assert.equal(result, "return (a + b);");
            });

    QUnit.test("genomeToString() null",
            function(assert)
            {
                // Setup.
                var isReturnUsed = false;
                var factory = new JSPhenotypeFactory("add", [ "a", "b" ],
                        isReturnUsed);
                var previous = LOGGER.isErrorEnabled();
                LOGGER.setErrorEnabled(false);

                // Run.
                try
                {
                    var result = factory.genomeToString(undefined);
                    throw SHOULD_THROW;
                }
                catch (e)
                {
                    assert.equal(e, "genome is null or empty.");
                }

                try
                {
                    var result = factory.genomeToString(null);
                    throw SHOULD_THROW;
                }
                catch (e)
                {
                    assert.equal(e, "genome is null or empty.");
                }

                try
                {
                    var result = factory.genomeToString([]);
                    throw SHOULD_THROW;
                }
                catch (e)
                {
                    assert.equal(e, "genome is null or empty.");
                }

                LOGGER.setErrorEnabled(previous);
            });

    QUnit.test("genomeToString() with if",
            function(assert)
            {
                // Setup.
                var genome = [ "if", ">", "a", "5", "=", "a", "+", "a", "6",
                        "return", "a", ";" ];
                var isReturnUsed = false;
                var factory = new JSPhenotypeFactory("maybeAdd", [ "a" ],
                        isReturnUsed);

                // Run.
                var result = factory.genomeToString(genome);

                // Verify.
                assert.ok(result);
                assert.equal(result,
                        "if ((a > 5)) {(a = (a + 6)); } return a ;");
            });

    QUnit
            .test(
                    "genomeToString() with if else",
                    function(assert)
                    {
                        // Setup.
                        var genome = [ "ifElse", ">", "a", "5", "=", "a", "+",
                                "a", "6", "=", "a", "-", "a", "7", "return",
                                "a", ";" ];
                        var isReturnUsed = false;
                        var factory = new JSPhenotypeFactory("maybeAdd",
                                [ "a" ], isReturnUsed);

                        // Run.
                        var result = factory.genomeToString(genome);

                        // Verify.
                        assert.ok(result);
                        assert
                                .equal(result,
                                        "if ((a > 5)) {(a = (a + 6)); } else {(a = (a - 7)); } return a ;");
                    });

    QUnit.test("genomeToString() 1 missing term",
            function(assert)
            {
                // Setup.
                var genome = [ "return", "+", "a" ];
                var isReturnUsed = false;
                var factory = new JSPhenotypeFactory("add", [ "a", "b" ],
                        isReturnUsed);

                // Run.
                var result = factory.genomeToString(genome);

                // Verify.
                assert.ok(result);
                assert.equal(result, "return (a + )");
            });

    QUnit.test("genomeToString() 2 missing terms",
            function(assert)
            {
                // Setup.
                var genome = [ "return", "+" ];
                var isReturnUsed = false;
                var factory = new JSPhenotypeFactory("add", [ "a", "b" ],
                        isReturnUsed);

                // Run.
                var result = factory.genomeToString(genome);

                // Verify.
                assert.ok(result);
                assert.equal(result, "return ( + )");
            });

    QUnit.test("JSPhenotypeFactory.isUnaryFunction()", function(assert)
    {
        assert.ok(JSPhenotypeFactory.isUnaryFunction("Math.abs"));
        assert.ok(!JSPhenotypeFactory.isUnaryFunction("!"));
        assert.ok(!JSPhenotypeFactory.isUnaryFunction("Math.atan2"));
        assert.ok(!JSPhenotypeFactory.isUnaryFunction("+"));
    });

    QUnit.test("JSPhenotypeFactory.isUnaryOperator()", function(assert)
    {
        assert.ok(!JSPhenotypeFactory.isUnaryOperator("Math.abs"));
        assert.ok(JSPhenotypeFactory.isUnaryOperator("!"));
        assert.ok(!JSPhenotypeFactory.isUnaryOperator("Math.atan2"));
        assert.ok(!JSPhenotypeFactory.isUnaryOperator("+"));
    });

    QUnit.test("JSPhenotypeFactory.isBinaryFunction()", function(assert)
    {
        assert.ok(!JSPhenotypeFactory.isBinaryFunction("Math.abs"));
        assert.ok(!JSPhenotypeFactory.isBinaryFunction("!"));
        assert.ok(JSPhenotypeFactory.isBinaryFunction("Math.atan2"));
        assert.ok(!JSPhenotypeFactory.isBinaryFunction("+"));
    });

    QUnit.test("JSPhenotypeFactory.isBinaryOperator()", function(assert)
    {
        assert.ok(!JSPhenotypeFactory.isBinaryOperator("Math.abs"));
        assert.ok(!JSPhenotypeFactory.isBinaryOperator("!"));
        assert.ok(!JSPhenotypeFactory.isBinaryOperator("Math.atan2"));
        assert.ok(JSPhenotypeFactory.isBinaryOperator("+"));
    });

    QUnit.test("JSPhenotypeFactory.parseChunk() sin", function(assert)
    {
        // Setup.
        var genome = [ "Math.sin", "theta" ];

        // Run.
        var result = JSPhenotypeFactory.parseChunk(genome);

        // Verify.
        assert.ok(result);
        assert.equal(result, "Math.sin(theta)");
    });

    QUnit.test("JSPhenotypeFactory.parseChunk() atan2", function(assert)
    {
        // Setup.
        var genome = [ "Math.atan2", "y", "x" ];

        // Run.
        var result = JSPhenotypeFactory.parseChunk(genome);

        // Verify.
        assert.ok(result);
        assert.equal(result, "Math.atan2(y, x)");
    });

    QUnit.test("JSPhenotypeFactory.parseChunk() add", function(assert)
    {
        // Setup.
        var genome = [ "+", "a", "b" ];

        // Run.
        var result = JSPhenotypeFactory.parseChunk(genome);

        // Verify.
        assert.ok(result);
        assert.equal(result, "(a + b)");
        assert.equal(genome.length, 0);
    });
</script>
</head>
<body>
	<div id="qunit"></div>
</body>
</html>
