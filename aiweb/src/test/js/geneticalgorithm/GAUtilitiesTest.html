<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>GAUtilitiesTest</title>

<link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.15.0.css">
<script src="http://code.jquery.com/qunit/qunit-1.15.0.js"></script>

<script src="../../../../../coreweb/lib/jshint/jshint-2.8.0.js"></script>

<script src="../../../../../coreweb/src/main/js/util/Logger.js"></script>
<script src="../../../../../coreweb/src/main/js/util/InputValidator.js"></script>
<script src="../../../../../coreweb/src/main/js/util/ArrayAugments.js"></script>
<script src="../../../../../coreweb/src/main/js/util/MathAugments.js"></script>

<script src="../../../main/js/geneticalgorithm/GAUtilities.js"></script>
<script src="../../../main/js/geneticalgorithm/GenomeFactory.js"></script>

<script>
    "use strict";

    var LOGGER = new Logger();

    QUnit.test("computeAverageFitness()", function(assert)
    {
        // Setup.
        var genomeLength = 4;
        var popSize = 10;
        var population = createPopulation(genomeLength, popSize);

        // Run.
        var result = GAUtilities.computeAverageFitness(population);

        // Verify.
        assert.ok(result);
        assert.equal(result, 5.5);
    });

    QUnit.test("computeImbalance()",
            function(assert)
            {
                // Setup.
                var genome0 = [ "var", "i", "=", "array.length", ";", "while",
                        "(", "i", "--", ")", "{", "if", "(", "array", "[", "i",
                        "]", "===", "element", ")", "{", "return true;", "}",
                        "}", "return false;", ];
                var genome1 = [ "{", "{", "}" ];
                var genome2 = [ "{", "}", "}" ];
                var genome3 = [ "{", "{", "}", "}" ];

                // Run / Verify.
                assert
                        .equal(GAUtilities.computeImbalance(genome0, "(", ")"),
                                0);
                assert
                        .equal(GAUtilities.computeImbalance(genome0, "[", "]"),
                                0);
                assert
                        .equal(GAUtilities.computeImbalance(genome0, "{", "}"),
                                0);

                assert
                        .equal(GAUtilities.computeImbalance(genome1, "(", ")"),
                                0);
                assert
                        .equal(GAUtilities.computeImbalance(genome1, "[", "]"),
                                0);
                assert
                        .equal(GAUtilities.computeImbalance(genome1, "{", "}"),
                                1);

                assert
                        .equal(GAUtilities.computeImbalance(genome2, "{", "}"),
                                1);
                assert
                        .equal(GAUtilities.computeImbalance(genome3, "{", "}"),
                                0);
            });

    QUnit.test("computeSumFitness()", function(assert)
    {
        // Setup.
        var genomeLength = 4;
        var popSize = 10;
        var population = createPopulation(genomeLength, popSize);
        // console.log("Population:\n" + GAUtilities.populationToString(population));

        // Run.
        var result = GAUtilities.computeSumFitness(population);

        // Verify.
        assert.ok(result);
        assert.equal(result, 55);
    });

    QUnit.test("count()", function(assert)
    {
        // Setup.
        var genome = [ 1, 2, 2, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 5 ];

        // Run / Verify.
        assert.equal(GAUtilities.count(genome, 0), 0);
        assert.equal(GAUtilities.count(genome, 1), 1);
        assert.equal(GAUtilities.count(genome, 2), 2);
        assert.equal(GAUtilities.count(genome, 3), 3);
        assert.equal(GAUtilities.count(genome, 4), 4);
        assert.equal(GAUtilities.count(genome, 5), 5);
        assert.equal(GAUtilities.count(genome, 6), 0);
    });

    QUnit.test("countErrors()", function(assert)
    {
        // Setup.
        var genome = [ "return", "=", "a", "+", "b", "-", "var", ";" ];
        var genomeString = GAUtilities.genomeToString(genome);
        genome.code = "function add(a, b) {" + genomeString + "}";
        JSHINT(genome.code);

        // Run.
        var result = GAUtilities.countErrors(JSHINT.errors);

        // Verify.
        assert.equal(result, 2);
    });

    QUnit.test("countWarnings()", function(assert)
    {
        // Setup.
        var genome = [ "-", "/", "=", "1", "2", "/" ];
        var genomeString = GAUtilities.genomeToString(genome);
        genome.code = "function add(a, b) {" + genomeString + "}";
        JSHINT(genome.code);

        // Run.
        var result = GAUtilities.countWarnings(JSHINT.errors);

        // Verify.
        assert.equal(result, 2);
    });

    QUnit.test("createPopulation()", function(assert)
    {
        // Setup.
        var popSize = 100;
        var genes = [ "a", "b", "c", "d", "e" ];
        var genomeLength = 3;
        var genomeFactory = new GenomeFactory(genes, genomeLength);

        // Run.
        var result = GAUtilities.createPopulation(popSize, genomeFactory);

        // Verify.
        assert.ok(result);
        assert.equal(result.length, popSize);
    });

    QUnit.test("determineNormalizedFitness()", function(assert)
    {
        // Setup.
        var genomeLength = 4;
        var popSize = 10;
        var population = createPopulation(genomeLength, popSize);
        // console.log("Population:\n" + GAUtilities.populationToString(population));

        // Run.
        GAUtilities.determineNormalizedFitness(population);
        var result0 = GAUtilities.round4(population[0].normalizedFitness);
        var result1 = GAUtilities.round4(population[1].normalizedFitness);
        var result2 = GAUtilities.round4(population[2].normalizedFitness);

        // Verify.
        assert.equal(result0, 0.1818);
        assert.equal(result1, 0.1636);
        assert.equal(result2, 0.1455);
    });

    QUnit.test("genomeToString()", function(assert)
    {
        // Setup.
        var genome = [ 1, 2, 3, 4 ];
        genome.fitness = 12.3;

        // Run.
        var result = GAUtilities.genomeToString(genome);

        // Verify.
        assert.ok(result);
        assert.equal(result, "1 2 3 4");
    });

    QUnit.test("genomeToLongString()", function(assert)
    {
        // Setup.
        var genome = [ 1, 2, 3, 4 ];
        genome.fitness = 12.3;

        // Run.
        var result = GAUtilities.genomeToLongString(genome);

        // Verify.
        assert.ok(result);
        assert.equal(result, "12.3:\t1 2 3 4");
    });

    QUnit.test("populationToString()", function(assert)
    {
        // Setup.
        var genomeLength = 4;
        var popSize = 10;
        var population = createPopulation(genomeLength, popSize);

        // Run.
        var result = GAUtilities.populationToString(population);

        // Verify.
        assert.equal(result, "10:\t0 1 2 3\n" + "9:\t1 2 3 4\n"
                + "8:\t2 3 4 5\n" + "7:\t3 4 5 6\n" + "6:\t4 5 6 7\n"
                + "5:\t5 6 7 8\n" + "4:\t6 7 8 9\n" + "3:\t7 8 9 10\n"
                + "2:\t8 9 10 11\n" + "1:\t9 10 11 12\n");
    });

    function createPopulation(genomeLength, popSize)
    {
        var population = [];

        for (var i = 0; i < popSize; i++)
        {
            var genome = [];

            for (var j = 0; j < genomeLength; j++)
            {
                genome[j] = i + j;
            }

            genome.fitness = popSize - i;
            population[population.length] = genome;
        }

        return population;
    }
</script>
</head>
<body>
	<div id="qunit"></div>
</body>
</html>
