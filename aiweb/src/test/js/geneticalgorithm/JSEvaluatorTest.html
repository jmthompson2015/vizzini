<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>JSEvaluatorTest</title>

<link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.15.0.css">
<script src="http://code.jquery.com/qunit/qunit-1.15.0.js"></script>

<script src="../../../../../coreweb/lib/jshint/jshint-2.8.0.js"></script>

<script src="../../../../../coreweb/src/main/js/util/Logger.js"></script>
<script src="../../../../../coreweb/src/main/js/util/InputValidator.js"></script>
<script src="../../../../../coreweb/src/main/js/util/ArrayAugments.js"></script>
<script src="../../../../../coreweb/src/main/js/util/MathAugments.js"></script>

<script src="../../../main/js/geneticalgorithm/GAUtilities.js"></script>
<script src="../../../main/js/geneticalgorithm/JSEvaluator.js"></script>
<script src="../../../main/js/geneticalgorithm/JSPhenotypeFactory.js"></script>

<script>
    "use strict";
    var LOGGER = new Logger();
    LOGGER.setTraceEnabled(false);
    LOGGER.setDebugEnabled(false);

    QUnit.test("computeMatches()",
            function(assert)
            {
                // Setup.
                var inputs = createInputs();
                var outputs = createOutputs();
                var phenotypeFactory = new JSPhenotypeFactory("contains", [
                        "array", "element" ]);
                var isMatches = true;
                var errorThreshold;
                var idealGenomeLength = 4;
                var evaluator = new JSEvaluator(inputs, outputs,
                        phenotypeFactory, isMatches, errorThreshold,
                        idealGenomeLength);
                var genome = [ "for (var i = 0; i < array.length; i++)",
                        "if (array[i] === element)", "return true;",
                        "return false;", ];
                var isDetailed = false;
                var phenotype = phenotypeFactory.create(genome, isDetailed);

                // Run.
                var result = evaluator.computeMatches(phenotype);

                // Verify.
                assert.equal(result, outputs.length);
            });

    QUnit.test("computeSumError() no errors",
            function(assert)
            {
                // Setup.
                var inputs = createInputs();
                var outputs = createOutputs();
                var phenotypeFactory = new JSPhenotypeFactory("contains", [
                        "array", "element" ]);
                var isMatches = true;
                var errorThreshold;
                var idealGenomeLength = 4;
                var evaluator = new JSEvaluator(inputs, outputs,
                        phenotypeFactory, isMatches, errorThreshold,
                        idealGenomeLength);
                var genome = [ "for (var i = 0; i < array.length; i++)",
                        "if (array[i] === element)", "return true;",
                        "return false;", ];
                var isDetailed = false;
                var phenotype = phenotypeFactory.create(genome, isDetailed);

                // Run.
                var result = evaluator.computeSumError(phenotype);

                // Verify.
                assert.equal(result, 0);
            });

    QUnit.test("computeSumError() NaN", function(assert)
    {
        // Setup.
        var inputs = [ [ 0, 0 ], [ 1, 2 ], [ 3, 4 ], [ 5, 6 ], [ 7, 8 ],
                [ 9, 10 ], ];
        var outputs = [ 0, 3, 7, 11, 15, 19 ];
        var phenotypeFactory = new JSPhenotypeFactory("add", [ "a", "b" ]);
        var isMatches = false;
        var errorThreshold = 0.0001;
        var idealGenomeLength = 4;
        var evaluator = new JSEvaluator(inputs, outputs, phenotypeFactory,
                isMatches, errorThreshold, idealGenomeLength);
        var genome = [ "return", "+", "+", "a", "b", "Number.NaN", ";" ];
        var isDetailed = false;
        var phenotype = phenotypeFactory.create(genome, isDetailed);

        // Run.
        var result = evaluator.computeSumError(phenotype);

        // Verify.
        assert.equal(result, 60);
    });

    QUnit.test("computeSumError() with issues", function(assert)
    {
        // Setup.
        var inputs = [ [ 0, 0 ], [ 1, 2 ], [ 3, 4 ], [ 5, 6 ], [ 7, 8 ],
                [ 9, 10 ], ];
        var outputs = [ 0, 3, 7, 11, 15, 19 ];
        var phenotypeFactory = new JSPhenotypeFactory("add", [ "a", "b" ]);
        var isMatches = false;
        var errorThreshold = 0.0001;
        var idealGenomeLength = 4;
        var evaluator = new JSEvaluator(inputs, outputs, phenotypeFactory,
                isMatches, errorThreshold, idealGenomeLength);
        var genome = [ "return", "/", "+", "a", "b", "0", ";" ];
        var isDetailed = false;
        var phenotype = phenotypeFactory.create(genome, isDetailed);

        // Run.
        var result = evaluator.computeSumError(phenotype);

        // Verify.
        assert.equal(result, Number.POSITIVE_INFINITY);
    });

    QUnit.test("evaluate() matches",
            function(assert)
            {
                // Setup.
                var inputs = createInputs();
                var outputs = createOutputs();
                var phenotypeFactory = new JSPhenotypeFactory("contains", [
                        "array", "element" ]);
                var isMatches = true;
                var errorThreshold;
                var idealGenomeLength = 4;
                var evaluator = new JSEvaluator(inputs, outputs,
                        phenotypeFactory, isMatches, errorThreshold,
                        idealGenomeLength);
                var genome = [ "for (var i = 0; i < array.length; i++)",
                        "if (array[i] === element)", "return true;",
                        "return false;", ];

                // Run.
                evaluator.evaluate([ genome ]);

                // Verify.
                assert.equal(genome.fitness, 1000.0);
                assert.ok(!genome.warningCount);
                assert.ok(!genome.errorCount);
            });

    QUnit.test("evaluate() numeric", function(assert)
    {
        // Setup.
        var inputs = [ [ 0, 0 ], [ 1, 2 ], [ 3, 4 ], [ 5, 6 ], [ 7, 8 ],
                [ 9, 10 ], ];
        var outputs = [ 0, 3, 7, 11, 15, 19 ];
        var phenotypeFactory = new JSPhenotypeFactory("add", [ "a", "b" ]);
        var isMatches = false;
        var errorThreshold = 0.0001;
        var idealGenomeLength = 4;
        var evaluator = new JSEvaluator(inputs, outputs, phenotypeFactory,
                isMatches, errorThreshold, idealGenomeLength);
        var genome = [ "return", "+", "a", "b" ];

        // Run.
        evaluator.evaluate([ genome ]);

        // Verify.
        assert.equal(genome.fitness, 1000.0);
        assert.ok(!genome.warningCount);
        assert.ok(!genome.errorCount);
    });

    QUnit.test("evaluate() numeric with issues", function(assert)
    {
        // Setup.
        var inputs = [ [ 0, 0 ], [ 1, 2 ], [ 3, 4 ], [ 5, 6 ], [ 7, 8 ],
                [ 9, 10 ], ];
        var outputs = [ 0, 3, 7, 11, 15, 19 ];
        var phenotypeFactory = new JSPhenotypeFactory("add", [ "a", "b" ]);
        var isMatches = false;
        var errorThreshold = 0.0001;
        var idealGenomeLength = 4;
        var evaluator = new JSEvaluator(inputs, outputs, phenotypeFactory,
                isMatches, errorThreshold, idealGenomeLength);
        var genome = [ "=", "return", "-", "+", "a", "b", "var", ";" ];

        // Run.
        evaluator.evaluate([ genome ]);

        // Verify.
        assert.ok(genome.fitness - 133.3333 < 0.0001);
        assert.equal(genome.warningCount, 8);
        assert.equal(genome.errorCount, 10);
    });

    function createInputs()
    {
        var inputs = [];
        var a = [ 1, 2, 3, 4 ];
        inputs[inputs.length] = [ a, -1 ];
        inputs[inputs.length] = [ a, 0 ];
        inputs[inputs.length] = [ a, 1 ];
        inputs[inputs.length] = [ a, 2 ];
        inputs[inputs.length] = [ a, 3 ];
        inputs[inputs.length] = [ a, 4 ];
        inputs[inputs.length] = [ a, 5 ];
        inputs[inputs.length] = [ a, 6 ];
        var b = [ 2, 4, 6, 8 ];
        inputs[inputs.length] = [ b, 1 ];
        inputs[inputs.length] = [ b, 2 ];
        inputs[inputs.length] = [ b, 3 ];
        inputs[inputs.length] = [ b, 4 ];
        inputs[inputs.length] = [ b, 5 ];
        inputs[inputs.length] = [ b, 6 ];
        inputs[inputs.length] = [ b, 7 ];
        inputs[inputs.length] = [ b, 8 ];

        return inputs;
    }

    function createOutputs()
    {
        var outputs = [ false, false, true, true, true, true, false, false, // a
        false, true, false, true, false, true, false, true, // b
        ];

        return outputs;
    }
</script>
</head>
<body>
	<div id="qunit"></div>
</body>
</html>
